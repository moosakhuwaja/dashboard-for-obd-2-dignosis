<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='../static/css/main.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>


</head>

<body>
    <header>
        <nav>
            <ul>
                {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a>
                    <a href="{{ url_for('logout') }}">Logout</a>
                </li>
                <li class="end">
                    <p id="walletAddress"></p>
                    <button id="connectWallet">Connect Wallet<img src="../static/icon/metamask.svg"
                            alt="metamasklogo"></button>

                </li>
                {% else %}
                <li><a href="{{ url_for('login') }}">Login</a>
                    <a href="{{ url_for('signup') }}">signup</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </header>

    <main style="width: auto; height: auto;">
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>&copy; 2023 My Website</p>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script type="text/javascript">
        window.userWalletAddress = null;
        const connectWallet = document.getElementById('connectWallet');
        const walletAddress = document.getElementById('walletAddress');
        const walletBalance = document.getElementById('walletBalance');

        function checkInstalled() {
            if (typeof window.ethereum === 'undefined') {
                connectWallet.innerText = 'MetaMask isn\'t installed, please install it';
                connectWallet.classList.remove();
                connectWallet.classList.add();
                return false;
            }
            connectWallet.addEventListener('click', connectWalletwithMetaMask);
        }

        async function connectWalletwithMetaMask() {
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) return;

                window.userWalletAddress = accounts[0];
                const prefix = window.userWalletAddress.substr(0, 4);
                const suffix = window.userWalletAddress.substr(-4);
                window.userWalletAddress = `${prefix}....${suffix}`;
                walletAddress.innerHTML = `<img src="../static/icon/ethereum.svg" alt="eth logo"> ${window.userWalletAddress}`;

                connectWallet.innerText = 'Sign Out';
                connectWallet.innerHTML += `<img src="../static/icon/metamask.svg" alt="eth logo">`
                connectWallet.removeEventListener('click', connectWalletwithMetaMask);
                setTimeout(() => {
                    connectWallet.addEventListener('click', signOutOfMetaMask);
                }, 200);
            } catch (e) {
                console.error(e.message);
            }
        }

        function signOutOfMetaMask() {
            window.userWalletAddress = null;
            walletAddress.innerText = '';
            connectWallet.innerHTML = ` Connect Wallet <img src="../static/icon/metamask.svg" alt="metamask logo">`;

            connectWallet.removeEventListener('click', signOutOfMetaMask);
            setTimeout(() => {
                connectWallet.addEventListener('click', connectWalletwithMetaMask);
            }, 200);
        }

        async function checkBalance() {
            try {
                const balance = await ethereum.request({
                    method: 'eth_getBalance',
                    params: [
                        window.userWalletAddress,
                        'latest'
                    ]
                });
                const balanceEth = web3.utils.fromWei(balance, 'ether');
                console.log(parseFloat(balanceEth));

                walletBalance.innerText = parseFloat(balanceEth);
            } catch (err) {
                console.error(err);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkInstalled();
        });


    </script>
</body>

</html>